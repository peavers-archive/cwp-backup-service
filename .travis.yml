language: java
jdk: oraclejdk8
sudo: required

services:
  - docker

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/

after_success:
  - docker --version
  - docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"
  - export PATH=$PATH:$HOME/.local/bin

  # TAG
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH; fi`

  # SILVERSTRIPE CLIENT
  - export CONFIG=$PROJECT/silverstripe-client
  - docker build -t $CONFIG ./silverstripe-client
  - docker tag $CONFIG:$TAG $CONFIG:$TAG
  - docker push $CONFIG:$TAG

  # SILVERSTRIPE SERVICE
  - export CONFIG=$PROJECT/silverstripe-service
  - docker build -t $CONFIG ./silverstripe-service
  - docker tag $CONFIG:$TAG $CONFIG:$TAG
  - docker push $CONFIG:$TAG
